/*!
 * Tiny Merge Tags plugin
 *
 * Copyright (c) 2022 Ephox Corporation DBA Tiny Technologies, Inc.
 * Licensed under the Tiny commercial license. See https://www.tiny.cloud/legal/
 *
 * Version: 1.0.0-21
 */

!function(){"use strict";const e=e=>t=>(e=>{const t=typeof e;return null===e?"null":"object"===t&&Array.isArray(e)?"array":"object"===t&&(n=r=e,(o=String).prototype.isPrototypeOf(n)||(null===(a=r.constructor)||void 0===a?void 0:a.name)===o.name)?"string":t;var n,r,o,a})(t)===e,t=e("string"),n=e("object"),r=e("array"),o=e=>!(e=>null==e)(e),a=e=>"function"==typeof e,s=e=>parseInt(e,10),i=(e,t)=>{const n=e-t;return 0===n?0:n>0?1:-1},l=(e,t,n)=>({major:e,minor:t,patch:n}),u=e=>{const t=/([0-9]+)\.([0-9]+)\.([0-9]+)(?:(\-.+)?)/.exec(e);return t?l(s(t[1]),s(t[2]),s(t[3])):l(0,0,0)};class c{constructor(e,t){this.tag=e,this.value=t}static some(e){return new c(!0,e)}static none(){return c.singletonNone}fold(e,t){return this.tag?t(this.value):e()}isSome(){return this.tag}isNone(){return!this.tag}map(e){return this.tag?c.some(e(this.value)):c.none()}bind(e){return this.tag?e(this.value):c.none()}exists(e){return this.tag&&e(this.value)}forall(e){return!this.tag||e(this.value)}filter(e){return!this.tag||e(this.value)?this:c.none()}getOr(e){return this.tag?this.value:e}or(e){return this.tag?this:e}getOrThunk(e){return this.tag?this.value:e()}orThunk(e){return this.tag?this:e()}getOrDie(e){if(this.tag)return this.value;throw new Error(null!=e?e:"Called getOrDie on None")}static from(e){return o(e)?c.some(e):c.none()}getOrNull(){return this.tag?this.value:null}getOrUndefined(){return this.value}each(e){this.tag&&e(this.value)}toArray(){return this.tag?[this.value]:[]}toString(){return this.tag?`some(${this.value})`:"none()"}}c.singletonNone=new c(!1);const g=Array.prototype.slice,m=Array.prototype.push,h=(e,t)=>{const n=e.length,r=new Array(n);for(let o=0;o<n;o++){const n=e[o];r[o]=t(n,o)}return r},d=(e,t)=>{for(let n=0,r=e.length;n<r;n++)t(e[n],n)},p=e=>{const t=[];for(let n=0,o=e.length;n<o;++n){if(!r(e[n]))throw new Error("Arr.flatten item "+n+" was not an array, input: "+e);m.apply(t,e[n])}return t},f=(e,t)=>p(h(e,t)),v=(e,t)=>{for(let n=0,r=e.length;n<r;++n)if(!0!==t(e[n],n))return!1;return!0},y=Object.hasOwnProperty,w=(e,t)=>y.call(e,t),x=e=>w(e,"title")&&t(e.title)&&e.title.length>0&&w(e,"menu")&&r(e.menu)&&e.menu.length>0&&v(e.menu,b),b=e=>n(e)&&((e=>w(e,"value")&&t(e.value)&&e.value.length>0)(e)||x(e)),N=e=>{const t=r(n=e)&&n.length>0&&v(n,b);var n;return t?{valid:t,value:e}:{valid:t,message:"Must be a non-empty array of objects matching the configuration schema: https://www.tiny.cloud/docs/tinymce/6/mergetags/"}},_=e=>t=>t.options.get(e),O=_("mergetags_prefix"),T=_("mergetags_suffix"),j=_("mergetags_list"),A=(e,t)=>{const n=[];for(let r=e.indexOf(t);-1!==r;r=e.indexOf(t,r+t.length))n.push(r);return n},C=(e,t,n)=>((e,t,n)=>{const r=A(e,t);if(0===r.length)return c.none();const o=A(e,n);if(0===o.length)return c.none();const a=h(r,(e=>[e,-1]));for(let e=o.length-1;e>=0;e--)for(let n=r.length-1;n>=0;n--)if(o[e]>r[n]+t.length){a[n][1]=o[e];break}const s=((e,t)=>{const n=[];for(let t=0,r=e.length;t<r;t++){const r=e[t];-1!==r[1]&&n.push(r)}return n})(a),i=h(s,(([e,t])=>[e,t+n.length]));return l=i,i.length>0?c.some(l):c.none();var l})(e,t,n).map((r=>h(((e,t)=>{const n=p(e);let r=!1;0===n[0]?r=!0:n.unshift(0),n[n.length-1]!==t&&n.push(t);const o=[];for(let e=0;e<n.length-1;e++)n[e]!==n[e+1]&&o.push({isTag:r,indexes:[n[e],n[e+1]]}),r=!r;return o})(r,e.length),(({isTag:r,indexes:[o,a]})=>r?{isTag:r,content:e.substring(o+t.length,a-n.length)}:{isTag:r,content:e.substring(o,a)})))),k="data-mce-mergetag",S="data-mce-mergetag-affix",E="mce-mergetag-affix",I=(e,t,n)=>{const r=tinymce.html.Node.create("span",{class:"mce-mergetag",contenteditable:"false","data-mce-cef-wrappable":"true",[k]:"1"}),o=tinymce.html.Node.create("span",{class:E,[S]:""}),a=tinymce.html.Node.create("#text");a.value=t,o.append(a);const s=tinymce.html.Node.create("span",{class:E,[S]:""}),i=tinymce.html.Node.create("#text");i.value=n,s.append(i);const l=tinymce.html.Node.create("#text");return l.value=e,r.append(o),r.append(l),r.append(s),r},M=(e,t,n)=>tinymce.html.Serializer().serialize(I(e,t,n)),P=e=>d(e,(e=>e.unwrap())),L=e=>{if(null==e)throw new Error("Node cannot be null or undefined");return{dom:e}},R=L;"undefined"!=typeof window?window:Function("return this;")();const z=e=>t=>(e=>e.dom.nodeType)(t)===e,F=z(1),B=z(9),D=z(11),q=e=>B(e)?e:R(e.dom.ownerDocument),H=a(Element.prototype.attachShadow)&&a(Node.prototype.getRootNode)?e=>R(e.dom.getRootNode()):q,U=e=>e.dom.blur(),V=e=>{const t=(e=>(e=>D(e)&&o(e.dom.host))(e)?e:R(q(e).dom.body))(H(R(e.getElement())));var n;(n=t,((e=(()=>R(document))())=>c.from(e.dom.activeElement).map(R))(H(n)).filter((e=>n.dom.contains(e.dom)))).filter(("input",e=>F(e)&&"input"===e.dom.nodeName.toLowerCase())).each(U)},G=e=>t(e.title)&&e.title.length>0?e.title:e.value;function K(e,t){const n=O(e),r=T(e),o=t=>h(t,(t=>(t=>x(t)?{type:"nestedmenuitem",text:t.title,getSubmenuItems:()=>o(t.menu)}:{type:"menuitem",text:G(t),value:t.value,onAction:()=>{return o=t.value,V(e),void e.insertContent(M(o,n,r));var o}})(t)));return o(t)}const W=(e,t)=>{if(0===t.length)return e;{const n=t.toLowerCase(),r=f(e,(e=>{const t=((e,t,n)=>{const r=e.toLowerCase().indexOf(n),o=t.toLowerCase().indexOf(n),a=r>-1,s=o>-1;return a&&s?Math.min(r,o):a?r:s?o:-1})(e.text,e.value,n);return t>=0?[{item:e,index:t}]:[]})),o=((e,t)=>{const n=g.call(e,0);return n.sort(((e,t)=>e.index-t.index)),n})(r);return h(o,(({item:e})=>e))}},$=e=>{const t=(e,n)=>((e,n,r)=>(d(e,((e,n)=>{var o,a;o=r,r=x(a=e)?t(a.menu,o):[...o,a]})),r))(e,0,n);return t(e,[])};tinymce.PluginManager.requireLangPack("mergetags","ar,bg_BG,ca,cs,da,de,el,es,eu,fa,fi,fr_FR,he_IL,hi,hr,hu_HU,id,it,ja,kk,ko_KR,ms,nb_NO,nl,pl,pt_BR,pt_PT,ro,ru,sk,sl_SI,sv_SE,th_TH,tr,uk,vi,zh_CN,zh_TW"),tinymce.PluginManager.add("mergetags",(e=>{if(((e,t)=>!!e&&-1===((e,t)=>{const n=i(e.major,t.major);if(0!==n)return n;const r=i(e.minor,t.minor);if(0!==r)return r;const o=i(e.patch,t.patch);return 0!==o?o:0})((e=>u((e=>[e.majorVersion,e.minorVersion].join(".").split(".").slice(0,3).join("."))(e)))(e),u(t)))(tinymce,"6.2.0"))return void console.error("The mergetags plugin requires at least version 6.2.0 of TinyMCE.");(e=>{const t=e.options.register;t("mergetags_list",{processor:N}),t("mergetags_prefix",{processor:"string",default:"{{"}),t("mergetags_suffix",{processor:"string",default:"}}"})})(e),(e=>{e.on("PreInit",(()=>{const{serializer:n,parser:r}=e,o=O(e),a=T(e);r.addNodeFilter("#text",((e,n)=>r=>{const o=e.length+n.length,a=f(r,(r=>c.from(r.value).filter((e=>e.length>o&&!(e=>{let n=e;for(;n=n.parent;){const e=n.attr("contenteditable");if(t(e))return"false"===e}return!1})(r))).map((t=>({node:r,fragments:C(t,e,n)}))).toArray()));d(a,(({node:t,fragments:r})=>{const o=tinymce.html.Node.create("span");r.each((r=>{d(r,(({isTag:t,content:r})=>{if(t)o.append(I(r,e,n));else{const e=tinymce.html.Node.create("#text");e.value=r,o.append(e)}})),t.replace(o),o.unwrap()}))}))})(o,a)),n.addAttributeFilter([k,S].join(","),P)}))})(e);const n=j(e);o(n)?(((e,t)=>{const n=O(e),r=T(e),o=$(t),a=h(o,(e=>({text:G(e),...e})));e.ui.registry.addAutocompleter("mergetags",{trigger:n,minChars:0,columns:1,fetch:e=>Promise.resolve(W(a,e)),onAction:(t,o,a)=>{e.selection.setRng(o),e.insertContent(M(a,n,r)),t.hide()}})})(e,n),((e,t)=>{const n=K(e,t),r=((e,t)=>K(e,$(t)))(e,t);e.ui.registry.addMenuButton("mergetags",{tooltip:"Insert merge tag",icon:"addtag",search:{placeholder:"Filter merge tags"},fetch:(e,t)=>{t.pattern.length>0?e((e=>{const t=W(r,e);return t.length>0?t:[{type:"menuitem",value:"stub",text:"No matches",enabled:!1}]})(t.pattern)):e(n)}})})(e,n),((e,t)=>{const n=K(e,t);var r;e.ui.registry.addNestedMenuItem("mergetags",{text:"Merge tag",icon:"addtag",getSubmenuItems:(r=n,()=>r)})})(e,n)):console.warn("No entries added to the mergetags_list option yet. The toolbar button and menu item for the mergetags plugin will be hidden.")}))}();